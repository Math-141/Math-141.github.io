---
pagetitle: "Chi-squared test of independence"
editor: source
format: 
  revealjs:
    html-math-method: mathjax
    chalkboard: true
    incremental: true
    theme: [default, custom.scss]
    height: 900
    width: 1600
    slide-number: c
    auto-stretch: false
    callout-appearance: simple
    pdf-max-pages-per-slide: 2
    menu: 
      side: right
      numbers: true
execute:
  echo: true
  warning: false
  message: false
---

```{r}
#| include: false
#| warning: false
#| message: false
options(digits = 2)
library(knitr)
library(tidyverse)
library(ggthemes)
library(moderndive)
library(gapminder)
library(infer)
library(gridExtra)
library(kableExtra)
```

::::: columns
::: {.column .center width="60%"}
![](img/DAW.jpeg){width="90%"}
:::

::: {.column .center width="40%"}
<br>

[Chi-squared test of independence]{.custom-title}

<br> <br>

[Grayson White]{.custom-subtitle}

[Math 141 <br> Week 13 \| Fall 2025]{.custom-subtitle}
:::
:::::

------------------------------------------------------------------------

### Goals for Today

::: columns
::: column
-   Chi-squared tests
:::

::: column
-   Chi-squared distribution
:::
:::

# Continuing our Discussion of Moving Beyond BINARY Categorical Variables

---

### Inference for Categorical Variables

Consider the situation where:

-   Response variable: categorical

-   Explanatory variable: categorical

-   Parameter of interest: $p_1 - p_2$

    -   This parameter of interest only makes sense if **both** variables only have two categories.

::: fragment
It is time to learn how to study the relationship between two categorical variables when **at least one has more than two categories.**
:::

------------------------------------------------------------------------

### Hypotheses

$H_o$: The two variables are independent.

$H_a$: The two variables are dependent.

------------------------------------------------------------------------

### Example

Near-sightedness typically develops during the childhood years. Quinn, Shin, Maguire, and Stone (1999) explored whether there is a relationship between the type of light children were exposed to and their eye health based on questionnaires filled out by the children's parents at a university pediatric ophthalmology clinic.

```{r}
library(tidyverse)
library(infer)

# Import data
eye_data <- read_csv("data/eye_lighting.csv")

# Contingency table
eye_data %>%
  count(Lighting, Eye)
```

------------------------------------------------------------------------

### Eyesight Example

Does there appear to be a relationship/dependence?

```{r}
#| output-location: column

ggplot(data = eye_data, 
       mapping = aes(x = Lighting,
                     fill = Eye)) + 
  geom_bar(position = "fill")
```

------------------------------------------------------------------------

### Test Statistic

Need a test statistic!

-   Won't be a single sample statistic.

-   Needs to measure the discrepancy between the observed sample and the sample we'd expect to see if $H_o$ (no relationship) were true.

-   Would be nice if its null distribution could be approximated by a known probability model.

------------------------------------------------------------------------

## Sample Result Tables

::: columns
::: column
#### Observed Sample Table

```{r}
table(eye_data$Eye, eye_data$Lighting) %>%
  addmargins() %>%
  kable(format = "html")
```
:::

::: column
#### Expected Sample Table

**Question**: If $H_o$ were correct, is this the table that we'd expect to see?

```{r, echo=FALSE}
Ho_dat <- data.frame(Eye = rep(c("Far", "Near", "Normal"), times = 53*3),
                     Lighting = rep(c("dark", "night", "room"), each = 53*3))
table(Ho_dat$Eye, Ho_dat$Lighting) %>%
  addmargins() %>%
  kable(format = "html")
```
:::
:::

------------------------------------------------------------------------

## Sample Result Tables

::: columns
::: column
#### Observed Sample Table

```{r}
table(eye_data$Eye, eye_data$Lighting) %>%
  addmargins() %>%
  kable(format = "html")
```
:::

::: column
#### Expected Sample Table

**Question**: If $H_o$ were correct, what table would we expect to see?

Want a $H_o$ table that respects the overall eye condition proportions:

$$\hat{p}_{far} = 91/479$$

$$\hat{p}_{nor} = 251/479$$

$$\hat{p}_{nea} = 137/479$$
:::
:::

------------------------------------------------------------------------

## Sample Result Tables {.smaller}

::: columns
::: column
#### Observed Sample Table

```{r}
table(eye_data$Eye, eye_data$Lighting) %>%
  addmargins() %>%
  kable(format = "html")
```
:::

::: column
#### Expected Sample Table

**Question**: If $H_o$ were correct, what table would we expect to see?

|        |         dark |        night |        room | Sum |
|:-------|-------------:|-------------:|------------:|----:|
| Far    |  (91/479)172 |  (91/479)232 |  (91/479)75 |  91 |
| Near   | (137/479)172 | (137/479)232 | (137/479)75 | 137 |
| Normal | (251/479)172 | (251/479)232 | (251/479)75 | 251 |
| Sum    |          172 |          232 |          75 | 479 |
:::
:::

Still have the same totals but distributed the values differently within the table

------------------------------------------------------------------------

## Sample Result Tables

::: columns
::: column
#### Observed Sample Table

```{r}
table(eye_data$Eye, eye_data$Lighting) %>%
  addmargins() %>%
  kable(format = "html")
```
:::

::: column
#### Expected Sample Table

**Question**: If $H_o$ were correct, what table would we expect to see?

```{r, echo = FALSE}
round(chisq.test(table(eye_data$Eye, eye_data$Lighting))$exp, 1) %>%
  addmargins() %>%
  kable(format = "html")
```
:::
:::

------------------------------------------------------------------------

### Expected Table

::: columns
::: column
How does this table represent $H_o$?

```{r, echo = FALSE}
round(chisq.test(table(eye_data$Eye, eye_data$Lighting))$exp, 2) %>%
  addmargins() %>%
  kable(format = "html")
```
:::

::: column
```{r, echo = FALSE}
chisq.test(table(eye_data$Eye, eye_data$Lighting))$exp %>%
  as_tibble(rownames = "Eye") %>%
  pivot_longer(2:4, names_to = "Lighting") %>%
  ggplot(mapping = aes(x = Lighting, fill = Eye, y = value)) +
  geom_col(position = "fill")
```
:::
:::

------------------------------------------------------------------------

### Test Statistic

Want the test statistic to quantify the difference between the observed table and the expected table.

::: columns
::: column
|        | dark | night | room | Sum |
|:-------|-----:|------:|-----:|----:|
| Far    |   40 |    39 |   12 |  91 |
| Near   |   18 |    78 |   41 | 137 |
| Normal |  114 |   115 |   22 | 251 |
| Sum    |  172 |   232 |   75 | 479 |
:::

::: column
|        |   dark |  night |  room | Sum |
|:-------|-------:|-------:|------:|----:|
| Far    |  32.68 |  44.08 | 14.25 |  91 |
| Near   |  49.19 |  66.35 | 21.45 | 137 |
| Normal |  90.13 | 121.57 | 39.30 | 251 |
| Sum    | 172.00 | 232.00 | 75.00 | 479 |
:::
:::

::: fragment
For each cell: Compute a **Z-score**!

```{=tex}
\begin{align*}
\mbox{Z-score} &= \frac{\mbox{stat - mean}}{\mbox{SE}} \\
& = \frac{\mbox{observed - expected}}{\sqrt{\mbox{expected}}}
\end{align*}
```
:::

------------------------------------------------------------------------

### Test Statistic

Want the test statistic to quantify the difference between the observed table and the expected table.

```{r, echo = FALSE}
round(chisq.test(table(eye_data$Eye, eye_data$Lighting))$residuals, 2) %>%
  kable(format = "html")
```

------------------------------------------------------------------------

### Test Statistic

**Test Statistic Formula:**

```{=tex}
\begin{align*}
\chi^2 = \sum \left(\frac{\mbox{observed - expected}}{\sqrt{\mbox{expected}}} \right)^2
\end{align*}
```
```{r}
#| output-location: column

library(infer)
#Compute Chi-square test stat
test_stat <- eye_data %>%
  specify(Eye ~ Lighting) %>%
  calculate(stat = "Chisq") 
test_stat
```

Questions:

1.  Is a test statistic **unusual** if it is a large number or a small number?
2.  Is 56.5 **unusual** under $H_o$?

------------------------------------------------------------------------

### Generating the Null Distribution

```{r}
#| output-location: column

# Construct null distribution
null_dist <- eye_data %>%
  specify(Eye ~ Lighting) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "Chisq")


visualize(null_dist)
```

------------------------------------------------------------------------

### The Null Distribution

::: columns
::: column
**Key Observations about the distribution**:

Smallest possible value?

Shape?

Is our observed test statistic of 56.5 unusual?
:::

::: column
```{r, echo = FALSE}
visualize(null_dist)
```
:::
:::

------------------------------------------------------------------------

### The P-value

```{r}
# Compute p-value
null_dist %>%
  get_pvalue(obs_stat = test_stat, direction = "greater")
```

------------------------------------------------------------------------

### Approximating the Null Distribution

If there are at least 5 observations in each cell, then

$$
\mbox{test statistic} \sim \chi^2(df = (k - 1)(j - 1))
$$ where $k$ is the number of categories in the response variable and $j$ is the number of categories in the explanatory variable.

The $df$ controls the center and spread of the distribution.

------------------------------------------------------------------------

### The Chi-Squared Test

```{r}
chisq_test(eye_data, Eye ~ Lighting)
```

-   Conclusions?

-   Causal link between room lighting at bedtime and eye conditions?

