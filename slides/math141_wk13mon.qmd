---
pagetitle: "ANOVA"
editor: source
format: 
  revealjs:
    chalkboard: true
    incremental: true
    theme: [default, custom.scss]
    height: 900
    width: 1600
    slide-number: c
    auto-stretch: false
    callout-appearance: simple
    pdf-max-pages-per-slide: 2
    menu: 
      side: right
      numbers: true
execute:
  echo: true
  warning: false
  message: false
---

```{r}
#| include: false
#| warning: false
#| message: false
options(digits = 2)
library(knitr)
library(tidyverse)
library(ggthemes)
library(moderndive)
library(gapminder)
library(infer)
library(gridExtra)
library(kableExtra)
```

::::: columns
::: {.column .center width="60%"}
![](img/DAW.jpeg){width="90%"}
:::

::: {.column .center width="40%"}
<br>

[Regression Inference III and ANOVA]{.custom-title}

<br> <br>

[Grayson White]{.custom-subtitle}

[Math 141 <br> Week 13 \| Fall 2025]{.custom-subtitle}
:::
:::::

------------------------------------------------------------------------

## Announcements

-  Don't forget to sign up for an oral exam slot!
    
### Goals for Today

::: columns
::: column
-   Discuss inference for regression with categorical variables.
-   Introduce the **ANOVA** test.
:::

::: column
-   Learn about the F distribution.
:::
:::

------------------------------------------------------------------------


### Example

Do Audience Ratings vary by movie genre?

```{r}
library(tidyverse)
# Load data
library(Lock5Data)
movies <- HollywoodMovies2011 %>%
  filter(!(Genre %in% c("Fantasy", "Adventure"))) %>%
  drop_na(Genre, AudienceScore)
```

::: nonincremental

* **Cases**:


* **Variables of interest (including type)**:


* **Hypotheses**:

:::

------------------------------------------------------------------------

### Example

::: columns
::: column

Does there appear to be a relationship?

```{r movies, fig.show = 'hide'}
ggplot(data = movies, 
       mapping = aes(x = Genre,
                     y = AudienceScore)) + 
  geom_boxplot() +     
  stat_summary(fun = mean, geom = "point", 
               color = "purple",
               shape = 8, size = 3)
```

:::
::: column

```{r, echo = FALSE}
knitr::include_graphics(knitr::fig_chunk("movies", "png"))
```

:::
:::


* What movie did the audience hate so much??


---

### Example

Does there appear to be a relationship?

```{r}
#| output-location: column

bad <- filter(movies, 
        AudienceScore == min(AudienceScore))
ggplot(data = movies, 
       mapping = aes(x = Genre,
                     y = AudienceScore)) + 
  geom_boxplot() +     
  stat_summary(fun = mean, geom = "point", 
               color = "purple",
               shape = 8, size = 3) +
  geom_label(data = bad, 
             mapping = aes(label = Movie))
```




What movie did the audience hate so much??

---

### Trespass

```{r, echo = FALSE}
knitr::include_graphics("img/trespass.001.jpeg")
```




# Okay, how could we answer our original question? 

::: {.fragment}
Do Audience Ratings vary by movie genre?
:::


## Let's do inference for regression to find out!


```{r}
# fit the model
mod <- lm(AudienceScore ~ Genre, movies)
get_regression_table(mod)
```

::: {.fragment}

**What tests are occurring here?**

:::


::: {.fragment}

$H_o: \beta_j = 0$, $H_A: \beta_j \neq 0$. For $j > 0$, we are testing if there is a **difference** from the baseline group. For $j = 0$ we are testing if the baseline group is different than 0.

:::


::: {.fragment}

**What sort of test might we want to carry out more often?**

:::



# Inference for Many Means

---

### Inference for Many Means

Consider the situation where:

* Response variable: quantitative

* Explanatory variable: categorical


* Parameter of interest: $\mu_1 - \mu_2$



* This parameter of interest only makes sense if the explanatory variable is restricted to two categories.

* Can use linear regression but in the special case of categorical explanatory variables, we have another option.
    + It is time to learn how to conduct inference for **more than two** means.

---

### Hypotheses

Consider the situation where:

* Response variable: quantitative

* Explanatory variable: categorical


::: fragment

$H_o$: $\mu_1 = \mu_2 = \cdots = \mu_K$  (Variables are independent/not related.)

$H_a$: At least one mean is not equal to the rest. (Variables are dependent/related)

:::

---

### Example

Do Audience Ratings vary by movie genre?

```{r}
library(tidyverse)
# Load data
library(Lock5Data)
movies <- HollywoodMovies2011 %>%
  filter(!(Genre %in% c("Fantasy", "Adventure"))) %>%
  drop_na(Genre, AudienceScore)
```

::: nonincremental

* **Cases**:


* **Variables of interest (including type)**:


* **Hypotheses**:

:::

---



### Test Statistic

Need a test statistic!

* Won't be a sample statistic.  

::: fragment

$$
\bar{x}_1 - \bar{x}_2 - \cdots - \bar{x}_K \mbox{ won't work!}
$$

:::



* Needs to measure the discrepancy between the **observed** sample and the sample **we'd expect** to see if $H_o$ were true.


* Would be nice if its null distribution could be approximated by a known probability model.

******************************


We'll consider a test called "ANOVA"


* Called "Analysis of **VARIANCE**" test.



* Not called "Analysis of **MEANS**" test.



* **Question**: Why analyze **variability** to test differences in means?

---

###  Why analyze **variability** to test differences in means?

Let's look at some simulated data for a moment.

```{r, echo = FALSE, fig.width=12, fig.asp = 0.5}
library(gridExtra)
#Fake Data 
set.seed(4341)
dat <- data.frame(response1 = rnorm(n=100*3, mean = (1:3)*1, sd = 3), 
                  response2 = rnorm(n=100*3, mean = (1:3)*4, sd = 1),
                  response3 = rnorm(n=100*3, mean = (1:3)*4, sd = 3),
                  expl = rep(c("a", "b", "c"), 100*3))
# Boxplots
p1 <- ggplot(data = dat, mapping = aes(x = expl, y = response1)) +
  geom_boxplot() + ylim(-10, 20) +
  geom_jitter(alpha = 0.05, width = .1, height = 0) +
  stat_summary(fun.y = mean, colour = "red", geom="point",
               shape = 8, size = 3) + 
  labs(title = "Scenario 1")
p2 <- ggplot(data = dat, mapping = aes(x = expl, y = response2)) +
  geom_boxplot() + ylim(-10, 20) +
  geom_jitter(alpha = 0.05, width = .1, height = 0) +
  stat_summary(fun.y = mean, colour = "red", geom="point",
               shape = 8, size = 3)  + 
  labs(title = "Scenario 2")
p3 <- ggplot(data = dat, mapping = aes(x = expl, y = response3)) +
  geom_boxplot() + ylim(-10, 20) +
  geom_jitter(alpha = 0.05, width = .1, height = 0) +
  stat_summary(fun.y = mean, colour = "red", geom="point",
               shape = 8, size = 3)  + 
  labs(title = "Scenario 3")
grid.arrange(p1, p2, p3, ncol = 3)
```

**Question**: For which scenario are you most convinced that the means are different?

---

### Key Idea: Partitioning the Variability

::: columns
::: column

```{r, echo = FALSE, fig.width=12, fig.asp = 0.5}
grid.arrange(p1, p2, p3, ncol = 3)
```

:::
::: column

\begin{align*}
& \mbox{Total Variability} = \\
& \mbox{Variability Between Groups} + \\
& \mbox{Variability Within Groups}
\end{align*}

:::
:::


::: columns
::: column

* Variability **Between** Groups: How much the group means vary
    + Compare the red dots.

:::
::: column

* Variability **Within** Groups: How much natural group variability there is
    + Within groups, compare the black dots to the red dot.
 
:::
:::

---

### Key Idea: Partitioning the Variability

* Total Variability: How much points vary from the overall mean

\begin{align*}
\mbox{Total Variability} &= \sum_{i=1}^n  (x_i - \bar{x})^2 \\
& = \mbox{Sum of Squares Total} \\
& = \mbox{SSTotal} 
\end{align*}


---

### Key Idea: Partitioning the Variability



* Variability **Between** Groups: How much the group means vary
    + Compare the red dots.

::: fragment    

\begin{align*}
\mbox{Variability Between Groups} &= \sum_{k = 1}^K n_k (\bar{x}_k - \bar{x})^2 \\
& = \mbox{Sum of Squares Group} \\
& = \mbox{SSG} 
\end{align*}

:::

---

### Key Idea: Partitioning the Variability

* Variability **Within** Groups: How much natural group variability there is
    + Within groups, compare the black dots to the red dot.
    
::: fragment

\begin{align*}
\mbox{Variability Within Groups} &= \sum_{k = 1}^{K} \sum_{i = 1}^{n_k}  (x_{ik} - \bar{x}_k)^2 \\
& = \mbox{Sum of Squares Error} \\
& = \mbox{SSE} 
\end{align*}


\begin{align*}
\mbox{Total Variability} & = \mbox{Variability Between Groups} + \mbox{Variability Within Groups}
\end{align*}

:::


---

### Mean Squares

Need to standardize the Sums of Squares to compare SSG to SSE.


\begin{align*}
\mbox{Mean Variability Between Groups} & = \frac{\mbox{SSG}}{K - 1} = MSG
\end{align*}

\begin{align*}
\mbox{Mean Variability Within Groups} & = \frac{\mbox{SSE}}{n - K} = MSE
\end{align*}


* Now on a comparable scale!  

* Now we can create a test statistic that compares these two measures of variability.

---

## Test Statistic {.smaller}

In some ways, MSG is the natural test statistic but as we saw for this example, MSG alone isn't enough.

```{r, echo = FALSE, fig.width=12, fig.asp = 0.4}
grid.arrange(p1, p2, p3, ncol = 3)
```


* Scenarios 2 and 3 have roughly the same MSG but we are much more convinced that the means are different for 2 than 3.  


* That is where MSE comes in!

---

### Test Statistic

$$
F = \frac{\mbox{MSG}}{\mbox{MSE}} = \frac{\mbox{variance between groups}}{\mbox{variance within groups}}
$$

* If $H_o$ is true, then $F$ should be roughly equal to what?



* If $H_a$ is true, then $F$ should be greater than 1 because there is more variation in the group means than we'd expect if the population means are all equal.

---

### Returning to the Movies Example

```{r}
library(infer)
#Compute F test stat
test_stat <- movies %>%
  specify(AudienceScore ~ Genre) %>%
  calculate(stat = "F") 
test_stat
```


* Is 3.88 a **large** test statistic?  Is a test statistic of 3.88 **unusual** under $H_o$?

---

### Generating the Null Distribution

::: columns
::: column

```{r, echo = FALSE}
movies %>%
  select(AudienceScore, Genre) %>%
  sample_n(20)
```

:::
::: column

**Steps**:

1. Shuffle Genre.
2. Compute the $MSE$ and $MSG$.  
3. Compute the test statistic.
4. Repeat 1 - 3 many times.

:::
:::

---

### Generating the Null Distribution



```{r}
#| output-location: column

# Construct null distribution
null_dist <- movies %>%
  specify(AudienceScore ~ Genre) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "F") 
visualize(null_dist)
```



---

### The Null Distribution

::: columns
::: column


**Key Observations**:

* Smallest possible value?

<br>

* Shape?

:::
::: column

```{r, echo = FALSE}
visualize(null_dist)
```

:::
:::



---

### The Null Distribution


::: columns
::: column


**Key Observations**:


* Is our observed test statistic unusual?


:::
::: column

```{r, echo = FALSE}
visualize(null_dist) +
  geom_vline(mapping = aes(xintercept = test_stat$stat), 
             color = "deeppink")
```

:::
:::






---

### The P-value

```{r}
# Compute p-value
null_dist %>%
  get_pvalue(obs_stat = test_stat, direction = "greater")
```

---

### Approximating the Null Distribution

::: columns
::: column


If 

::: nonincremental

* There are at least 30 observations **in each group** or the response variable is normal
* The variability is similar for all groups 

:::



:::
::: column

```{r, echo = FALSE}
visualize(null_dist, method = "both", 
          dens_color = "orange")
```

:::
:::

then 

$$
\mbox{test statistic} \sim F(df1 = K - 1, df2 = n - K)
$$

---

### The ANOVA Test

Check assumptions!

```{r}
movies %>%
  group_by(Genre) %>%
  summarize(n(), sd(AudienceScore))
```


---

### The ANOVA Test

Check assumptions!

```{r, fig.width=12, fig.asp = 0.4}
ggplot(data = movies, mapping = aes(x = AudienceScore)) + 
  geom_histogram(bins = 15) + 
  facet_wrap(~Genre)
```


---

### The ANOVA Test

```{r}
mod_anova <- aov(AudienceScore ~ Genre, data = movies)
summary(mod_anova)
```

---

## Many ANOVA Tests Out There!

* We learned the **One-Way** ANOVA test.


* **Two-Way**: Have two categorical, explanatory variables.


* **Repeated Measures ANOVA**: Have multiple observations on each case.
    + All the tests we have focused on assumed independent observations.
    


* **ANOVA Tests for Regression**: Allow comparisons of various subsets of a multiple linear regression model.


# Next time: more categorical variable inference